
export let group_size = "128";
let depthPrecision = "1000.0";

export let csColor = `

#version 450

layout(local_size_x = ${group_size}, local_size_y = 1) in;

layout(set = 0, binding = 0) uniform Uniforms {
	mat4 worldView;
	mat4 proj;
	uint width;
	uint height;
	uint numPoints;
} uniforms;


layout(std430, set = 0, binding = 1) buffer SSBO_COLORS {
	uint ssbo_colors[];
};

layout(std430, set = 0, binding = 2) buffer SSBO_DEPTH {
	uint ssbo_depth[];
};

layout(std430, set = 0, binding = 3) buffer SSBO_position {
	float positions[];
};

layout(std430, set = 0, binding = 4) buffer SSBO_color {
	uint colors[];
};

uint readU16(uint offset){
	uint ipos = offset / 4u;
	uint value = colors[ipos];

	if((offset & 2u) > 0u){
		value = (value >> 16) & 0xFFFFu;
	}else{
		value = value & 0xFFFFu;
	}

	return value;
}



void main(){

	uint index = gl_GlobalInvocationID.x;

	if(index >= uniforms.numPoints){
		return;
	}

	vec4 pos_point = vec4(
		positions[3 * index + 0],
		positions[3 * index + 1],
		positions[3 * index + 2],
		1.0);

	vec4 viewPos = uniforms.worldView * pos_point;
	vec4 pos = uniforms.proj * viewPos;

	pos.xyz = pos.xyz / pos.w;

	if(pos.w <= 0.0 || pos.x < -1.0 || pos.x > 1.0 || pos.y < -1.0 || pos.y > 1.0){
		return;
	}

	ivec2 imageSize = ivec2(
		int(uniforms.width),
		int(uniforms.height)
	);

	vec2 imgPos = (pos.xy * 0.5 + 0.5) * imageSize;
	ivec2 pixelCoords = ivec2(imgPos);
	int pixelID = pixelCoords.x + pixelCoords.y * imageSize.x;

	//uint color = colors[index];

	//uint r = (color >> 0) & 0xFFu;
	//uint g = (color >> 8) & 0xFFu;
	//uint b = (color >> 16) & 0xFFu;

	uint r = readU16(6 * index + 0) / 256;
	uint g = readU16(6 * index + 2) / 256;
	uint b = readU16(6 * index + 4) / 256;

	// uint r = 0;
	// uint g = 255;
	// uint b = 0;

	uint depth = uint(-viewPos.z * ${depthPrecision});
	uint bufferedDepth = ssbo_depth[pixelID];
	uint wip_pixel = ssbo_colors[2 * pixelID + 1];
	uint wip_fragcount = wip_pixel & 0xFFFF;

	float blendFactor = 1.001;
	if(depth <= blendFactor * bufferedDepth){
		// atomicAdd(ssbo_colors[4 * pixelID + 0], r);
		// atomicAdd(ssbo_colors[4 * pixelID + 1], g);
		// atomicAdd(ssbo_colors[4 * pixelID + 2], b);
		// atomicAdd(ssbo_colors[4 * pixelID + 3], 1);

		uint rg = (r << 16) | g;
		uint bc = (b << 16) | 1;
		uint old_rg = atomicAdd(ssbo_colors[2 * pixelID + 0], rg);
		uint old_bc = atomicAdd(ssbo_colors[2 * pixelID + 1], bc);

	}
}

`;


export let precompiled = new Uint32Array([119734787, 65536, 524296, 234, 0, 131089, 1, 393227, 1, 1280527431, 1685353262, 808793134, 0, 196622, 0, 1, 393231, 5, 4, 1852399981, 0, 11, 393232, 4, 17, 128, 1, 1, 196611, 2, 450, 262149, 4, 1852399981, 0, 262149, 8, 1701080681, 120, 524293, 11, 1197436007, 1633841004, 1986939244, 1952539503, 1231974249, 68, 327685, 20, 1718185557, 1936552559, 0, 393222, 20, 0, 1819438967, 1701402212, 119, 327686, 20, 1, 1785688688, 0, 327686, 20, 2, 1952737655, 104, 327686, 20, 3, 1734960488, 29800, 393222, 20, 4, 1349350766, 1953393007, 115, 327685, 22, 1718185589, 1936552559, 0, 327685, 34, 1601400688, 1852403568, 116, 393221, 36, 1329746771, 1936683103, 1869182057, 110, 393222, 36, 0, 1769172848, 1852795252, 115, 196613, 38, 0, 262149, 61, 2003134838, 7565136, 196613, 67, 7565168, 327685, 121, 1734438249, 2053722981, 101, 262149, 133, 1348955497, 29551, 327685, 143, 1702390128, 1869562732, 7562354, 262149, 147, 1702390128, 4475244, 262149, 156, 1869377379, 114, 327685, 158, 1329746771, 1819239263, 29295, 327686, 158, 0, 1869377379, 29554, 196613, 160, 0, 196613, 164, 114, 196613, 169, 103, 196613, 174, 98, 262149, 179, 1953523044, 104, 393221, 186, 1717990754, 1684370021, 1953523012, 104, 327685, 188, 1329746771, 1346716767, 18516, 393222, 188, 0, 1868723059, 1885693023, 26740, 196613, 190, 0, 327685, 194, 1852140642, 1667319396, 7499636, 327685, 206, 1329746771, 1280263007, 5460559, 393222, 206, 0, 1868723059, 1819239263, 7565935, 196613, 208, 0, 262215, 11, 11, 28, 262216, 20, 0, 5, 327752, 20, 0, 35, 0, 327752, 20, 0, 7, 16, 262216, 20, 1, 5, 327752, 20, 1, 35, 64, 327752, 20, 1, 7, 16, 327752, 20, 2, 35, 128, 327752, 20, 3, 35, 132, 327752, 20, 4, 35, 136, 196679, 20, 2, 262215, 22, 34, 0, 262215, 22, 33, 0, 262215, 35, 6, 4, 327752, 36, 0, 35, 0, 196679, 36, 3, 262215, 38, 34, 0, 262215, 38, 33, 3, 262215, 157, 6, 4, 327752, 158, 0, 35, 0, 196679, 158, 3, 262215, 160, 34, 0, 262215, 160, 33, 4, 262215, 187, 6, 4, 327752, 188, 0, 35, 0, 196679, 188, 3, 262215, 190, 34, 0, 262215, 190, 33, 2, 262215, 205, 6, 4, 327752, 206, 0, 35, 0, 196679, 206, 3, 262215, 208, 34, 0, 262215, 208, 33, 1, 262215, 233, 11, 25, 131091, 2, 196641, 3, 2, 262165, 6, 32, 0, 262176, 7, 7, 6, 262167, 9, 6, 3, 262176, 10, 1, 9, 262203, 10, 11, 1, 262187, 6, 12, 0, 262176, 13, 1, 6, 196630, 17, 32, 262167, 18, 17, 4, 262168, 19, 18, 4, 458782, 20, 19, 19, 6, 6, 6, 262176, 21, 2, 20, 262203, 21, 22, 2, 262165, 23, 32, 1, 262187, 23, 24, 4, 262176, 25, 2, 6, 131092, 28, 262176, 33, 7, 18, 196637, 35, 17, 196638, 36, 35, 262176, 37, 2, 36, 262203, 37, 38, 2, 262187, 23, 39, 0, 262187, 6, 40, 3, 262176, 44, 2, 17, 262187, 6, 49, 1, 262187, 6, 55, 2, 262187, 17, 59, 1065353216, 262176, 62, 2, 19, 262187, 23, 68, 1, 262167, 73, 17, 3, 262176, 76, 7, 17, 262187, 17, 85, 0, 262187, 17, 92, 3212836864, 262167, 119, 23, 2, 262176, 120, 7, 119, 262187, 23, 122, 2, 262187, 23, 126, 3, 262167, 131, 17, 2, 262176, 132, 7, 131, 262187, 17, 136, 1056964608, 262176, 146, 7, 23, 196637, 157, 6, 196638, 158, 157, 262176, 159, 2, 158, 262203, 159, 160, 2, 262187, 6, 167, 255, 262187, 23, 171, 8, 262187, 23, 176, 16, 262187, 17, 183, 1148846080, 196637, 187, 6, 196638, 188, 187, 262176, 189, 2, 188, 262203, 189, 190, 2, 262187, 17, 195, 1065361605, 196637, 205, 6, 196638, 206, 205, 262176, 207, 2, 206, 262203, 207, 208, 2, 262187, 6, 232, 128, 393260, 9, 233, 232, 49, 49, 327734, 2, 4, 0, 3, 131320, 5, 262203, 7, 8, 7, 262203, 33, 34, 7, 262203, 33, 61, 7, 262203, 33, 67, 7, 262203, 120, 121, 7, 262203, 132, 133, 7, 262203, 120, 143, 7, 262203, 146, 147, 7, 262203, 7, 156, 7, 262203, 7, 164, 7, 262203, 7, 169, 7, 262203, 7, 174, 7, 262203, 7, 179, 7, 262203, 7, 186, 7, 262203, 76, 194, 7, 327745, 13, 14, 11, 12, 262205, 6, 15, 14, 196670, 8, 15, 262205, 6, 16, 8, 327745, 25, 26, 22, 24, 262205, 6, 27, 26, 327854, 28, 29, 16, 27, 196855, 31, 0, 262394, 29, 30, 31, 131320, 30, 65789, 131320, 31, 262205, 6, 41, 8, 327812, 6, 42, 40, 41, 327808, 6, 43, 42, 12, 393281, 44, 45, 38, 39, 43, 262205, 17, 46, 45, 262205, 6, 47, 8, 327812, 6, 48, 40, 47, 327808, 6, 50, 48, 49, 393281, 44, 51, 38, 39, 50, 262205, 17, 52, 51, 262205, 6, 53, 8, 327812, 6, 54, 40, 53, 327808, 6, 56, 54, 55, 393281, 44, 57, 38, 39, 56, 262205, 17, 58, 57, 458832, 18, 60, 46, 52, 58, 59, 196670, 34, 60, 327745, 62, 63, 22, 39, 262205, 19, 64, 63, 262205, 18, 65, 34, 327825, 18, 66, 64, 65, 196670, 61, 66, 327745, 62, 69, 22, 68, 262205, 19, 70, 69, 262205, 18, 71, 61, 327825, 18, 72, 70, 71, 196670, 67, 72, 262205, 18, 74, 67, 524367, 73, 75, 74, 74, 0, 1, 2, 327745, 76, 77, 67, 40, 262205, 17, 78, 77, 393296, 73, 79, 78, 78, 78, 327816, 73, 80, 75, 79, 262205, 18, 81, 67, 589903, 18, 82, 81, 80, 4, 5, 6, 3, 196670, 67, 82, 327745, 76, 83, 67, 40, 262205, 17, 84, 83, 327868, 28, 86, 84, 85, 262312, 28, 87, 86, 196855, 89, 0, 262394, 87, 88, 89, 131320, 88, 327745, 76, 90, 67, 12, 262205, 17, 91, 90, 327864, 28, 93, 91, 92, 131321, 89, 131320, 89, 458997, 28, 94, 86, 31, 93, 88, 262312, 28, 95, 94, 196855, 97, 0, 262394, 95, 96, 97, 131320, 96, 327745, 76, 98, 67, 12, 262205, 17, 99, 98, 327866, 28, 100, 99, 59, 131321, 97, 131320, 97, 458997, 28, 101, 94, 89, 100, 96, 262312, 28, 102, 101, 196855, 104, 0, 262394, 102, 103, 104, 131320, 103, 327745, 76, 105, 67, 49, 262205, 17, 106, 105, 327864, 28, 107, 106, 92, 131321, 104, 131320, 104, 458997, 28, 108, 101, 97, 107, 103, 262312, 28, 109, 108, 196855, 111, 0, 262394, 109, 110, 111, 131320, 110, 327745, 76, 112, 67, 49, 262205, 17, 113, 112, 327866, 28, 114, 113, 59, 131321, 111, 131320, 111, 458997, 28, 115, 108, 104, 114, 110, 196855, 117, 0, 262394, 115, 116, 117, 131320, 116, 65789, 131320, 117, 327745, 25, 123, 22, 122, 262205, 6, 124, 123, 262268, 23, 125, 124, 327745, 25, 127, 22, 126, 262205, 6, 128, 127, 262268, 23, 129, 128, 327760, 119, 130, 125, 129, 196670, 121, 130, 262205, 18, 134, 67, 458831, 131, 135, 134, 134, 0, 1, 327822, 131, 137, 135, 136, 327760, 131, 138, 136, 136, 327809, 131, 139, 137, 138, 262205, 119, 140, 121, 262255, 131, 141, 140, 327813, 131, 142, 139, 141, 196670, 133, 142, 262205, 131, 144, 133, 262254, 119, 145, 144, 196670, 143, 145, 327745, 146, 148, 143, 12, 262205, 23, 149, 148, 327745, 146, 150, 143, 49, 262205, 23, 151, 150, 327745, 146, 152, 121, 12, 262205, 23, 153, 152, 327812, 23, 154, 151, 153, 327808, 23, 155, 149, 154, 196670, 147, 155, 262205, 6, 161, 8, 393281, 25, 162, 160, 39, 161, 262205, 6, 163, 162, 196670, 156, 163, 262205, 6, 165, 156, 327874, 6, 166, 165, 39, 327879, 6, 168, 166, 167, 196670, 164, 168, 262205, 6, 170, 156, 327874, 6, 172, 170, 171, 327879, 6, 173, 172, 167, 196670, 169, 173, 262205, 6, 175, 156, 327874, 6, 177, 175, 176, 327879, 6, 178, 177, 167, 196670, 174, 178, 327745, 76, 180, 61, 55, 262205, 17, 181, 180, 262271, 17, 182, 181, 327813, 17, 184, 182, 183, 262253, 6, 185, 184, 196670, 179, 185, 262205, 23, 191, 147, 393281, 25, 192, 190, 39, 191, 262205, 6, 193, 192, 196670, 186, 193, 196670, 194, 195, 262205, 6, 196, 179, 262256, 17, 197, 196, 262205, 17, 198, 194, 262205, 6, 199, 186, 262256, 17, 200, 199, 327813, 17, 201, 198, 200, 327868, 28, 202, 197, 201, 196855, 204, 0, 262394, 202, 203, 204, 131320, 203, 262205, 23, 209, 147, 327812, 23, 210, 24, 209, 327808, 23, 211, 210, 39, 393281, 25, 212, 208, 39, 211, 262205, 6, 213, 164, 458986, 6, 214, 212, 49, 12, 213, 262205, 23, 215, 147, 327812, 23, 216, 24, 215, 327808, 23, 217, 216, 68, 393281, 25, 218, 208, 39, 217, 262205, 6, 219, 169, 458986, 6, 220, 218, 49, 12, 219, 262205, 23, 221, 147, 327812, 23, 222, 24, 221, 327808, 23, 223, 222, 122, 393281, 25, 224, 208, 39, 223, 262205, 6, 225, 174, 458986, 6, 226, 224, 49, 12, 225, 262205, 23, 227, 147, 327812, 23, 228, 24, 227, 327808, 23, 229, 228, 126, 393281, 25, 230, 208, 39, 229, 458986, 6, 231, 230, 49, 12, 49, 131321, 204, 131320, 204, 65789, 65592]);